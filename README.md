# System Design социальной сети для курса по System Design
## Функциональные требования 
- Аккаунт путешественника
   - Создание
   - Удаление
- Подписываться на акаунты других
- Посты из путешествий
   - Содержат
     - Ссылки на картинки
     - Имя и описание
     - Координаты места
     - Даты путешествия
   - Могут иметь оценки других пользователей
   - Могут иметь комментарии других пользователей
   - Есть возможность удалить/скрыть
   - Один пост содержит имя до 100 символов(utf-8), описание до 1000 символов(utf-8) и до 4 фотографий(вес каждой до 1 мб) в формате .png/.jpg.
- Лента путешествий
   - Просматривать ленту путешествий своих подписок(сортировка по времени)
   - Просматривать ленту путешествий лучших путешествий за время(за день/за неделю/за месяц/за все время)
   - Просматривать путешествия конкретного юзера(сортировка по времени/лайкам)
   - Просматривать свои путешествия
     - Строить места на карте, как в google maps, где можно смотреть где ты был за некоторое время на карте
     - За конкретные промежутки времени
   - Возможность оценивать и комментировать посты других юзеров
- Сообщения
  - Писать сообщения другим пользователям и получать сообщения от них
  - Одно сообщение в переписке до 250 символов
- Места путешествий
  - Сбор оценок всех пользователей конкретного места
  - Сортировка мест путешествий по городам/регионам/странам
    - по средней оценке
    - по числу постов с местом
- Поддержка различных устройств
- Время ответа на запросы не должно превышать 500 мс
## Нефункциональные требования 
- 10 000 000 DAU
- Данные храним всегда
- Используем пагинацию в запросах на получение списка мест, стандартное значение - 5
- Поддержка записей о путешествиях на языках общения аудитории стран СНГ
- Availability 99.95%
- Нормальное функционирование при увеличении числа использования сервиса во время сезона отпусков/праздников(1.5x от всех показателей)
- Частота использования
    - Юзер видит 5 записей о путешествиях других
    - Юзер создает свою запись о путешествии в среднем раз в 2 недели, в записи в среднем 1 фото, 25 символов названия и 200 символов описания.
    - Юзер пишет и читает 5 сообщений в день, сообщение в среднем длиной 50 символов
    - Юзер в среднем раз в 3 дня смотрит ленту другого человека(5 постов человека)
- Синхронизация между различными устройствами
## Архитектура системы
Для проектирования системы я использовал [C4 model](https://c4model.com/). C4 model была создана для того, чтобы помочь командам разработчиков программного обеспечения описывать архитектуру программного обеспечения и обмениваться информацией как во время предварительных сессий проектирования, так и при ретроспективном документировании существующей кодовой базы. Это способ создания карт вашего кода с различным уровнем детализации, аналогично тому, как вы использовали бы что-то вроде Google Maps для увеличения или уменьшения масштаба интересующей вас области.
<p align="center">
    </br><b>Level 1.</b> System context diagram</br></br>
</p>
<p align="center">
  <img src="arch/context.svg" />
</p>

## Расчет нагрузки и трафика данных
  - Будем использовать символы в кодировке utf-8 для поддержки языков стран СНГ и эмоджи:
      https://stackoverflow.com/questions/3662688/is-there-a-languages-which-will-require-three-or-more-bytes-per-character-when
  - Расчет будем производить с учетом пиковой нагрузки в сезон отпусков
  - RPS:
    - write
       - сохранение изображений
            ```
              10000000 * 1 / 14 / 86400 = 8
            ```
        - сохранения постов
            ```
              10000000 * 1 / 14 / 86400 = 8
            ```
        - отправка сообщений
            ```
              10000000 * 5 / 86400 = 579
            ```
    - read
        - просмотр ленты другого человека
            ```
              10000000 * 3 / 7 / 86400 = 50
            ```
        - просмотр ленты рекомендаций
            ```
              10000000 / 86400 = 116
            ```
        - просмотр сообщений 
            ```
              10000000 * 5 / 86400 = 579
            ```
  - Traffic
    - write
      ```
        Per second:
         сохранение изображений: 8 * 1000 = 8 MB
         сохранения постов: 8 * (25 * 2 + 200 * 2) = 4 MB
         отправка сообщений: 579 * 50 = 29 MB
         общее: 29 + 4 + 8 = 41 MB
        Daily: 41 * 86400 = 3.5 TB
        Mountly: 3.5 * 30 = 115 TB
        Yearly: 3.5 * 365 = 1.277 PB
      ```
    - read
      ```
        Per second: 
         просмотр ленты другого человека:  50 * 5 * 1000 + 50 * 5 * (25 * 2 + 200 * 2) = 362 MB
         просмотр ленты рекомендаций: 116 * 5 * (1000 + 25 * 2 + 200 * 2) = 841 MB
         просмотр сообщений: 579 * 50  = 29 MB
         общее: 362 + 841 + 29 = 1.232 GB
        Daily: 1.232 * 86400 = 106.45 TB
      ```
## Расчет требуемого числа дисков
Будем проводить рассчет требуемого числа дисков для хранения и обработки всех этих данных приложения на 1 год.
```
Capacity = 1277TB
IOPS = WriteOPS + ReadOPS = (8 + 8 + 579) + (50 + 116 + 579) = 1340
Throughput = WriteThroughput + ReadThroughput = 41 + 1232 = 1273 MB/s
Рассчитаем требуемое число дисков для HDD, SSD (SATA) и SSD (nVME).
```
#### HDD
Используем диски размеров 32 ТБ.
```
Disks_for_capacity = 1277 ТБ / 32 ТБ = 39.9
Disks_for_throughput = 1273 МБ/с / 100 МБ/с = 12.73
Disks_for_iops = 1340 / 100 = 13.4
Disks = max(ceil(39.9), ceil(12.73), ceil(13.4)) = 40
```
#### SSD (SATA)
Используем диски размеров 64 ТБ.
```
Disks_for_capacity = 1277 ТБ / 64 ТБ = 19.95
Disks_for_throughput = 1273 МБ/с / 1000 МБ/с = 1.27
Disks_for_iops = 1340 / 500 = 2.68
Disks = max(ceil(19.95), ceil(1.27), ceil(2.68)) = 20
```
#### SSD (nVME)
Используем диски размеров 64 ТБ.
```
Disks_for_capacity = 1277 ТБ / 64 ТБ = 19.95
Disks_for_throughput = 1273 МБ/с / 3000 МБ/с = 0.42
Disks_for_iops = 1340 / 10000 = 0.13
Disks = max(ceil(19.95), ceil(0.42), ceil(0.13)) = 20
```


Таким образом, с учетом того, что у нас не достаточно высокая нагрузка на чтение/запись и не большая передача трафика, то для нашего сервиса диск в первую очередь должен мочь хранить много информации, а показатели iops/throughput нам достаточны не такие большие. Но с учетом того, что HDD работает медленнее, чем SSD, можно выбрать 20 дисков SSD (SATA) объемом 64 ГБ.

## Расчет требуемого числа хостов
Для одного хоста будем использовать 2 диска. 
Hosts = disks / disks_per_host
Hosts = 20 / 2 = 10
Hosts_with_replication = hosts * replication_factor
Hosts_with_replication = 10 * 2 = 20
Таким образом, при использовании репликации будет использовано примерно 20 хостов 
